@*<link href="~/Scripts/layui/css/layui.css" rel="stylesheet" />*@

<div class="demoTable" style="padding-top:20px;">
    <form class="layui-form layui-form-pane" style="padding-left:10px;padding-right:10px;padding-top:20px;">
        @*&nbsp&nbsp
        公司：
        <div class="layui-inline">
            <input class="layui-input" id="company" autocomplete="off">
        </div>

        部门：
        <div class="layui-inline">
            <input class="layui-input" id="depertment" autocomplete="off">
        </div>
        姓名：
        <div class="layui-inline">
            <input class="layui-input" id="employee" autocomplete="off">
        </div>*@

        <div class="layui-form-item">
            <label class="layui-form-label">公司</label>
            <div class="layui-input-inline">
                <select name="Company_Name" id="Company_Name" lay-filter="Company_Name">
                    @*<option value="" selected=""></option>*@
                    @if (ViewBag.comList != null)
                    {
                        foreach (var emp in ViewBag.comList)
                        {
                            <option value="@emp.Company_Name">@emp.Company_Name</option>
                        }
                    }

                </select>
            </div>

            <label class="layui-form-label">部门</label>
            <div class="layui-input-inline">
                <select name="Department_Name" id="Department_Name" lay-filter="Department_Name">
                    <option value="" selected=""></option>
                    @if (ViewBag.depList != null)
                    {
                        foreach (var emp in ViewBag.depList)
                        {
                            <option value="@emp.Department_Name">@emp.Department_Name</option>
                        }
                    }
                </select>
            </div>

            <label class="layui-form-label">姓名</label>
            <div class="layui-inline">
                <input class="layui-input" id="employee" autocomplete="off">
            </div> 

            <button class="layui-btn" data-type="reload" type="button"  id="search">搜索</button>
            <button class="layui-btn layui-btn-primary"  type="button" data-type="add" id="add">添加</button>
            <button class="layui-btn layui-btn-primary"  type="button" data-type="uploadExcel" id="uploadExcel">导入</button>

        </div>
    </form>
</div> 
<table id="user" class="layui-table" lay-filter="user" lay-data="{  height: 'full-80', cellMinWidth: 120,toolbar: '#toolbar', page: true, limit: 20, url:'/User/getList'}">
    <thead>
        <tr>
            <th lay-data="{type: 'numbers'}"></th>
            <th lay-data="{field:'Chinese_Name',  sort: true}">姓名</th>
            <th lay-data="{field:'User_Name', sort: true}">用户名</th>
            <th lay-data="{field:'Company_Name',  sort: true}">公司</th>
            <th lay-data="{field:'Department_Name',  sort: true}">部门</th>
            <th lay-data="{field:'Position_Name', sort: true}">职位/岗位</th>
            <th lay-data="{field:'Role_Name', sort: true}">角色</th>
            <th lay-data="{ width:288, align:'center', toolbar: '#bar'}"></th>
        </tr>
    </thead>
</table>


@*<script src="~/Scripts/layui/layui.js"></script>*@
<script type="text/html" id="toolbar">
    @*<div class="layui-btn-container">
            //<button class="layui-btn layui-btn-sm" lay-event="getCheckData">获取选中行数据</button>
        </div>*@
</script>

<script type="text/html" id="bar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="reset">重置密码</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="addRole">绑定角色</a>
</script>

<script type="text/javascript">


    layui.use(['table', 'layer', 'form', 'element', 'upload'], function () {
        var table = layui.table;
        layer = layui.layer;
        form = layui.form;
        element = layui.element;
        upload = layui.upload;
        var $ = layui.$; //重点在layui中引用JQ必须写这一句


        //页面一打开就执行弹层
        layer.ready(function () {
            //执行重载
            table.reload('user', {
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                , where: {
                    company: $("#Company_Name").val(),
                    depertment: $("#Department_Name").val(),
                    employee: $("#employee").val(),
                    time: new Date()
                }
            });
        });

        //指定允许上传的文件类型
        upload.render({
            elem: '#uploadExcel'
            , url: '/User/uploadUser'
            , accept: 'file' //普通文件
            , exts: 'xls|xlsx'
            , before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                layer.load(); //上传loading
            }
            , done: function (res, index, upload) {
                layer.closeAll('loading'); //关闭loading
                layer.alert(res.msg, {
                    title: '提示'
                });
            }
            , error: function (index, upload) {
                layer.closeAll('loading'); //关闭loading
                layer.alert("上传出错", {
                    title: '提示'
                });
            }
        });
        //监听工具条
        table.on('tool(user)', function (obj) {
            var data = obj.data;
            var id = data.ID;
            if (obj.event === 'detail') {
                //layer.msg('ID：' + data.ID + ' 的查看操作');

            }
            else if (obj.event === 'del') {
                layer.confirm('数据删除之后将无法恢复', function (index) {
                    $.ajax({
                        'type': 'post',
                        'url': '/User/DelInfo',
                        'data': {
                            ID: id
                        },
                        success: function (data) {
                            var da = JSON.parse(data);
                            if (da.IsSuccess == "1") {

                                obj.del();
                                layer.close(index);
                                layer.alert(da.MessageString, {
                                    title: '提示'
                                });
                            }
                            else {
                                layer.alert(da.MessageString, {
                                    title: '提示'
                                });
                            }

                        },
                        error: function (message) {
                            layer.alert(JSON.stringify(message.statusText), {
                                title: '提示'
                            });
                        }

                    });



                });
            } else if (obj.event === 'reset') {
                layer.confirm('密码重置之后将无法恢复', function (index) {
                    $.ajax({
                        'type': 'post',
                        'url': '/User/ResetInfo',
                        'data': {
                            ID: id
                        },
                        success: function (data) {
                            var obj = JSON.parse(data);
                            if (obj.IsSuccess == "1") {

                                layer.alert(obj.MessageString, {
                                    title: '提示'
                                });
                            }
                            else {
                                layer.alert(obj.MessageString, {
                                    title: '提示'
                                });
                            }

                        },
                        error: function (message) {
                            layer.alert(JSON.stringify(message.statusText), {
                                title: '提示'
                            });
                        }

                    });
                    layer.close(index);

                });
            } else if (obj.event === 'edit') {
                //页面层
                layer.open({
                    type: 2,
                    title: "编辑用户信息",
                    skin: 'layui-layer-rim', //加上边框
                    area: ['430px', '400px'], //宽高
                    content: '/User/Edit2?ID=' + id
                });

            }
            else if (obj.event === 'addRole') {
                //页面层
                layer.open({
                    type: 2,
                    title: "绑定角色信息",
                    skin: 'layui-layer-rim', //加上边框
                    area: ['430px', '400px'], //宽高
                    content: '/User/AddRole?ID=' + id
                });

            }
        });

        form.on('select(Company_Name)', function (data) {
            $.ajax({
                type: 'POST',
                url: '/TZAssessmentDepartment/getAssessmentDepartment',
                data: { Company_Name: data.value },
                dataType: 'json',
                success: function (data) {
                    $("#Department_Name").html("");
                    var option1 = $("<option>").val("").text("");
                    $("#Department_Name").append(option1);
                    $.each(data, function (key, val) {
                        var option1 = $("<option>").val(val).text(val);
                        $("#Department_Name").append(option1);
                    });
                    form.render('select');
                    $("#Department_Name").get(0).selectedIndex = 0;
                }, error: function (message) {
                    $("#Department_Name").html("");
                }
            });
        });

        //搜索加载--数据表格重载
        var $ = layui.$, active = {
            reload: function () {
                //执行重载
                table.reload('user', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                    , where: {
                        company: $("#Company_Name").val(),
                        depertment: $("#Department_Name").val(),
                        employee: $("#employee").val(),
                        time: new Date()
                    }
                });
            }
        };

        $('#search').on('click', function () {
            ids = new Array();
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });


        $('#add').on('click', function () {

            layer.open({
                type: 2,
                title: "新增用户信息",
                skin: 'layui-layer-rim', //加上边框
                area: ['430px', '560px'], //宽高
                content: '/User/Add2'

            });
        });

    });

</script>